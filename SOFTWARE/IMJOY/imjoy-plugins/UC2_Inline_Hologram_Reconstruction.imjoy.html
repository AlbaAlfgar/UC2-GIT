#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Sun Jun 30 14:38:38 2019

@author: bene
"""

<docs lang="markdown">
Demo plugin to demonstrate how to plot charts in ImJoy. For this, some data is generated
in a Pythons plugin andd displayed in a separate window.

Here, we create an image (`.png`) in the Python plugin. This image is then send
to a window plugin and displayed there. Such an image is not restricted to simple charts,
and can thus also contain more complex data which can not be send by the plugin communicatino protocols.


</docs>

<config lang="json">
{
  "name": "Process Inline Hologram",
  "type": "native-python",
  "version": "0.0.1",
  "api_version": "0.1.2",
  "description": "Sending Image to the IMJOY plugin to backpropagate it into the sample plane.",
  "tags": [],
  "ui": [
          "Distance to the sensor plane: {id:'z_dist', type: 'number', min: 0, placeholder:1e-3}"
        ],
  "inputs": null,
  "outputs": null,
  "flags": [],
  "icon": "swap_horiz",
  "env": null,
  "requirements": ["numpy", "matplotlib"],
  "dependencies": []
}
</config>

<script lang="python">

# manage the imports
import matplotlib as mpl
mpl.use('Agg')

import matplotlib.pyplot as plt
plt.ioff()
import numpy as np
import base64
import asyncio
import os
import time
from src import FresnelPropagator as FP


class ImJoyPlugin():
    def setup(self):
        self.window = None
    
    async def run(self, my):

        api.showStatus('[DEMO] Python worker to plot charts')
        print(my.config.chart_type)
        
        
        ''' start plugin here '''
        
        # define some experimental parameters
        my_holo_file = 'test_microplastic.jpg'
        my_background_file = 'test2bg.jpg'
        mychannel = 2 # select the color channel 0,1,2
        mysize = 1024 # region of interest around the center coordinate 
        
        # define acquisition parameters
        pixelsize = 1.4e-6; #0.6e-6#.2e-6#3.000e-6;
        lambda0 = 440e-9; # in nanometer #530e-9;
        
        # start and stop z-focus measure
        stepsize = 0.001;
        
        # read the raw-hologram
        myholo = 1.*plt.imread(my_holo_file);
                              
        # select only the blue channel (because we used the blue LED)                     
        myholo = myholo[:,:,mychannel ]
        
        # crop out the ROI around the center to speed up computation (RADIX 2 please!)
        holosize = myholo.shape
        myholo =  myholo[int(holosize[0]/2-mysize/2):int(holosize[0]/2+mysize/2), int(holosize[0]/2-mysize/2):int(holosize[0]/2+mysize/2)]
        
        if(0):        
            # display intermediate result 
            plt.imshow(myholo)
            plt.colorbar()
            plt.show()
        
        # normalize hologram
        myholo = myholo/np.max(myholo);
        
        # estimate hologram's amplitude
        myamplitude = np.sqrt(myholo); 
        
        ## Backpropagate the Hologram
        # Fresnel Propagation - test out a range of z-values to find the one that
        # brings the bug into focus
        Ef = FP.FresnelPropagator(myholo, pixelsize, lambda0, zpos)
        
        # Plot curve and save as png
        fig1, ax = plt.subplots(num='RECONSTRUCTED HOLOGRAM')
        plt.imshow(Ef,cmap='gray')
        name_plot = 'HOLOGRAM.png'
        plt.savefig(name_plot,dpi=300)

        with open(name_plot, 'rb') as f:
            data = f.read()
            result = base64.b64encode(data).decode('ascii')
            imgurl = 'data:image/png;base64,' + result
            data = {"src": imgurl}

            data_plot = {
                'name':'Plot charts: show png',
                'type':'imjoy/image',
                'w':12, 'h':15,
                'data':data}

        ## Check if window was defined
        if self.window is None:
            self.window = await api.createWindow(data_plot)
            print(f'Window created')

        else:
            print(f'Update window.')
            try:
                await self.window.run(data=data)
            except:
                self.window = await api.createWindow(data_plot)
                print(f'Could not print to old window. New window created.')

api.export(ImJoyPlugin())

</script>
